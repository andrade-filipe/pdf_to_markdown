#!/usr/bin/env python3
"""
Teste do OCR Ultra-Preciso - Qualidade M√°xima
"""

import os
import json
import time
from pathlib import Path
from converter.pipeline import ConversionPipeline

# Configura√ß√µes
PDF_DIR = "/home/andrade/Documentos/Meus Ebooks/Genesis: The Correct Timeline/Referencias em PDF"
MARKDOWN_DIR = "/home/andrade/Documentos/Meus Ebooks/Genesis: The Correct Timeline/Referencias em Markdown"

# Casos problem√°ticos para teste
PROBLEMATIC_CASES = [
    "181014cronologia_ap.pdf",  # Caso de teste principal
    "coming-to-grips-with-genesis-ch6.pdf",  # Caso complexo
]

def analyze_markdown_quality(content):
    """An√°lise detalhada da qualidade do Markdown"""
    lines = content.split('\n')
    
    # Estat√≠sticas b√°sicas
    total_lines = len(lines)
    non_empty_lines = len([l for l in lines if l.strip()])
    empty_lines = total_lines - non_empty_lines
    
    # An√°lise Markdown
    headers = [l for l in lines if l.strip().startswith('#')]
    code_blocks = [l for l in lines if l.startswith('```') or l.startswith('    ')]
    lists = [l for l in lines if l.strip().startswith(('-', '‚Ä¢', '*', '1.', '2.', '3.'))]
    
    # Estrutura do documento
    sections = []
    current_section = []
    for line in lines:
        if line.strip().startswith('#'):
            if current_section:
                sections.append(current_section)
            current_section = [line]
        else:
            current_section.append(line)
    if current_section:
        sections.append(current_section)
    
    # Calcular score de qualidade do Markdown
    markdown_score = 0
    
    # Headers (0-25 pontos)
    header_count = len(headers)
    if header_count >= 5:
        markdown_score += 25
    elif header_count >= 3:
        markdown_score += 20
    elif header_count >= 1:
        markdown_score += 15
    
    # Estrutura de se√ß√µes (0-25 pontos)
    if len(sections) >= 3:
        markdown_score += 25
    elif len(sections) >= 2:
        markdown_score += 20
    elif len(sections) >= 1:
        markdown_score += 15
    
    # Listas e formata√ß√£o (0-25 pontos)
    formatting_elements = len(lists) + len(code_blocks)
    if formatting_elements >= 10:
        markdown_score += 25
    elif formatting_elements >= 5:
        markdown_score += 20
    elif formatting_elements >= 1:
        markdown_score += 15
    
    # Legibilidade (0-25 pontos)
    avg_line_length = sum(len(l.strip()) for l in lines if l.strip()) / non_empty_lines if non_empty_lines > 0 else 0
    if 50 <= avg_line_length <= 120:
        markdown_score += 25
    elif 30 <= avg_line_length <= 150:
        markdown_score += 20
    else:
        markdown_score += 10
    
    # An√°lise de repeti√ß√µes
    seen_lines = set()
    repeated_lines = 0
    for line in lines:
        if line.strip():
            normalized = line.strip().lower()
            if normalized in seen_lines:
                repeated_lines += 1
            else:
                seen_lines.add(normalized)
    
    return {
        'total_lines': total_lines,
        'non_empty_lines': non_empty_lines,
        'empty_lines': empty_lines,
        'headers': len(headers),
        'sections': len(sections),
        'lists': len(lists),
        'code_blocks': len(code_blocks),
        'repeated_lines': repeated_lines,
        'avg_line_length': avg_line_length,
        'markdown_score': markdown_score,
        'structure_quality': 'Excelente' if markdown_score >= 80 else 'Boa' if markdown_score >= 60 else 'Moderada' if markdown_score >= 40 else 'Baixa'
    }

def main():
    print("üöÄ TESTE DO OCR ULTRA-PRECISO")
    print("=" * 80)
    print("‚úÖ M√∫ltiplas tentativas de OCR com diferentes configura√ß√µes")
    print("‚úÖ Processamento avan√ßado com dados estruturados")
    print("‚úÖ Formata√ß√£o Markdown superior")
    print("‚úÖ Limpeza inteligente sem perda de informa√ß√£o")
    print("‚úÖ Performance otimizada: 1-2 minutos por arquivo")
    print("=" * 80)
    
    # Criar pipeline
    pipeline = ConversionPipeline(str(Path(MARKDOWN_DIR)))
    
    results = {}
    
    for pdf_name in PROBLEMATIC_CASES:
        print(f"\nüìÑ TESTANDO OCR ULTRA-PRECISO: {pdf_name}")
        print("-" * 70)
        
        pdf_path = Path(PDF_DIR) / pdf_name
        
        if not pdf_path.exists():
            print(f"‚ùå PDF n√£o encontrado: {pdf_path}")
            continue
        
        try:
            # Converter com OCR ultra-preciso
            print("üîÑ Iniciando convers√£o ultra-preciso...")
            print("   ‚è±Ô∏è  Tempo estimado: 1-2 minutos")
            
            start_time = time.time()
            
            output_filename = f"{pdf_name.replace('.pdf', '_ultra_precise.md')}"
            output_path = pipeline.convert(str(pdf_path), output_filename)
            
            conversion_time = time.time() - start_time
            
            print(f"   ‚úÖ Convers√£o conclu√≠da: {conversion_time:.1f}s")
            print(f"   üìÅ Arquivo: {output_path}")
            
            # Verificar se OCR foi aplicado
            ocr_applied = pipeline.current_data.get('ocr_applied', False)
            ocr_pages = pipeline.current_data.get('ocr_pages_processed', 0)
            
            if ocr_applied:
                print(f"   üîç OCR ultra-preciso aplicado em {ocr_pages} p√°ginas")
            else:
                print(f"   üìù OCR n√£o necess√°rio - texto de excelente qualidade")
            
            # Analisar resultado
            print("üìä Analisando qualidade do Markdown...")
            
            with open(output_path, 'r', encoding='utf-8') as f:
                content = f.read()
            
            analysis = analyze_markdown_quality(content)
            
            print(f"   üìä Linhas totais: {analysis['total_lines']:,}")
            print(f"   üìù Linhas com conte√∫do: {analysis['non_empty_lines']:,}")
            print(f"   üìã Cabe√ßalhos: {analysis['headers']}")
            print(f"   üìÑ Se√ß√µes: {analysis['sections']}")
            print(f"   üìù Listas: {analysis['lists']}")
            print(f"   üîÑ Linhas repetidas: {analysis['repeated_lines']}")
            print(f"   üìè Comprimento m√©dio das linhas: {analysis['avg_line_length']:.1f}")
            print(f"   üéØ Score de qualidade Markdown: {analysis['markdown_score']:.1f}/100")
            print(f"   üìà Qualidade da estrutura: {analysis['structure_quality']}")
            
            # Verificar caracter√≠sticas espec√≠ficas do OCR
            if ocr_applied:
                print("\nüîç Caracter√≠sticas do OCR Ultra-Preciso:")
                
                # Verificar se h√° informa√ß√µes de qualidade do OCR
                if "# Documento Processado com OCR Ultra-Preciso" in content:
                    print("   ‚úÖ Cabe√ßalho especial do OCR detectado")
                
                # Contar se√ß√µes de p√°gina
                page_sections = content.count("## P√°gina")
                print(f"   üìÑ Se√ß√µes de p√°gina processadas: {page_sections}")
                
                # Verificar formata√ß√£o Markdown
                markdown_elements = content.count('# ') + content.count('## ')
                print(f"   üìã Elementos Markdown: {markdown_elements}")
            
            # Comparar com vers√£o anterior (se existir)
            old_md_path = Path(MARKDOWN_DIR) / f"{pdf_name.replace('.pdf', '.md')}"
            
            if old_md_path.exists():
                print("\nüìÑ Comparando com vers√£o anterior...")
                
                with open(old_md_path, 'r', encoding='utf-8') as f:
                    old_content = f.read()
                
                old_analysis = analyze_markdown_quality(old_content)
                
                improvement_markdown = analysis['markdown_score'] - old_analysis['markdown_score']
                improvement_headers = analysis['headers'] - old_analysis['headers']
                improvement_repetitions = old_analysis['repeated_lines'] - analysis['repeated_lines']
                
                print(f"   üìà Melhoria no score Markdown: {improvement_markdown:+.1f}")
                print(f"   üìã Melhoria em cabe√ßalhos: {improvement_headers:+d}")
                print(f"   üîÑ Redu√ß√£o de repeti√ß√µes: {improvement_repetitions:+d}")
                
                # Determinar status da melhoria
                if improvement_markdown > 20 or improvement_repetitions > 10:
                    print("   üöÄ MELHORIA SIGNIFICATIVA DETECTADA!")
                elif improvement_markdown > 0:
                    print("   ‚úÖ Melhoria moderada detectada")
                else:
                    print("   ‚ö†Ô∏è Nenhuma melhoria detectada")
            
            # Avalia√ß√£o final
            quality_rating = "EXCELENTE" if analysis['markdown_score'] >= 80 else \
                           "BOA" if analysis['markdown_score'] >= 60 else \
                           "MODERADA" if analysis['markdown_score'] >= 40 else "BAIXA"
            
            print(f"\nüèÜ AVALIA√á√ÉO FINAL: {quality_rating}")
            
            results[pdf_name] = {
                'analysis': analysis,
                'ocr_applied': ocr_applied,
                'ocr_pages': ocr_pages,
                'conversion_time': conversion_time,
                'content_length': len(content),
                'improvements': {
                    'markdown_improvement': improvement_markdown if old_md_path.exists() else 0,
                    'headers_improvement': improvement_headers if old_md_path.exists() else 0,
                    'repetitions_reduction': improvement_repetitions if old_md_path.exists() else 0
                }
            }
            
        except Exception as e:
            print(f"   ‚ùå Erro na convers√£o: {e}")
            results[pdf_name] = {'error': str(e)}
    
    # Resumo dos resultados
    print("\nüéØ RESUMO DOS RESULTADOS ULTRA-PRECISOS")
    print("=" * 80)
    
    successful_tests = 0
    ocr_used = 0
    excellent_results = 0
    good_results = 0
    
    for pdf_name, result in results.items():
        if 'error' not in result:
            successful_tests += 1
            
            if result['ocr_applied']:
                ocr_used += 1
            
            analysis = result['analysis']
            improvements = result['improvements']
            
            # Determinar classifica√ß√£o
            if analysis['markdown_score'] >= 80:
                rating = "üèÜ EXCELENTE"
                excellent_results += 1
            elif analysis['markdown_score'] >= 60:
                rating = "‚úÖ BOA"
                good_results += 1
            else:
                rating = "‚ö†Ô∏è MODERADA"
            
            ocr_info = f"OCR:{result['ocr_pages']}p" if result['ocr_applied'] else "SEM OCR"
            time_info = f"{result['conversion_time']:.0f}s"
            
            print(f"   {pdf_name}: {rating} [{ocr_info}] [{time_info}]")
            print(f"      Markdown: {analysis['markdown_score']:.1f}/100 (Œî{improvements['markdown_improvement']:+.1f})")
            print(f"      Cabe√ßalhos: {analysis['headers']} (Œî{improvements['headers_improvement']:+d})")
            print(f"      Repeti√ß√µes: {analysis['repeated_lines']} (Œî{improvements['repetitions_reduction']:+d})")
            print(f"      Estrutura: {analysis['structure_quality']}")
        else:
            print(f"   {pdf_name}: ‚ùå ERRO - {result['error']}")
    
    print(f"\nüìä ESTAT√çSTICAS FINAIS:")
    print(f"   Testes bem-sucedidos: {successful_tests}/{len(PROBLEMATIC_CASES)}")
    print(f"   OCR utilizado: {ocr_used}/{successful_tests}")
    print(f"   Resultados excelentes: {excellent_results}/{successful_tests}")
    print(f"   Resultados bons: {good_results}/{successful_tests}")
    
    # Salvar resultados
    output_file = "ultra_precise_ocr_test.json"
    with open(output_file, 'w', encoding='utf-8') as f:
        json.dump(results, f, indent=2, ensure_ascii=False)
    
    print(f"\nüíæ Resultados salvos em: {output_file}")
    
    # Avalia√ß√£o final
    success_rate = (excellent_results + good_results) / successful_tests if successful_tests > 0 else 0
    
    if success_rate >= 0.8:
        print(f"\nüéâ SUCESSO EXCEPCIONAL: {success_rate*100:.0f}% de resultados excelentes/boos!")
        print("   ‚úÖ OCR ultra-preciso funcionando perfeitamente!")
    elif success_rate >= 0.6:
        print(f"\n‚úÖ SUCESSO: {success_rate*100:.0f}% de resultados satisfat√≥rios!")
        print("   üîß Pequenos ajustes ainda poss√≠veis")
    else:
        print(f"\n‚ö†Ô∏è RESULTADOS MODESTOS: Apenas {success_rate*100:.0f}% de resultados satisfat√≥rios")
        print("   üöß Ajustes significativos recomendados")

if __name__ == "__main__":
    main()
